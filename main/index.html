<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-C3 Health Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --accent-color: #06b6d4;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1e293b 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            padding: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            font-weight: 300;
        }

        .main-container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
        }

        .card h3 {
            font-size: 1.5em;
            margin-bottom: 25px;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 25px 0;
        }

        .health-value-box {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .heart-rate-box {
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: #fff;
        }

        .heart-rate-box::before,
        .heart-rate-box::after {
            content: "";
            position: absolute;
            top: 20px;
            right: 25px;
            width: 20px;
            height: 30px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50px 50px 0 0;
        }

        .heart-rate-box::before {
            transform: rotate(-45deg);
            transform-origin: 0 100%;
        }

        .heart-rate-box::after {
            transform: rotate(45deg);
            transform-origin: 100% 100%;
        }

        .spo2-box {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
        }

        .health-value {
            font-size: 3em;
            font-weight: 700;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 10px 0;
        }

        .health-unit {
            font-size: 1.2em;
            opacity: 0.9;
            font-weight: 300;
        }

        .status-text {
            font-size: 18px;
            color: var(--text-secondary);
            margin: 15px 0;
            font-weight: 500;
            text-align: center;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 25px 0;
        }

        .chart-card {
            position: relative;
            height: 320px;
            background: rgba(255,255,255,0.02);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .chart-card h4 {
            margin-bottom: 12px;
            color: var(--accent-color);
            font-weight: 600;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .connected {
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border: 1px solid var(--success-color);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
        }

        .disconnected {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid var(--danger-color);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
        }

        .footer {
            text-align: center;
            padding: 30px 0;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            margin-top: 50px;
        }

        .device-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }

        .motion-card {
            margin-top: 30px;
        }

        .motion-grid {
            display: grid;
            grid-template-columns: 1.3fr 1.2fr;
            gap: 20px;
            margin-top: 20px;
        }

        .motion-values {
            background: rgba(15,23,42,0.8);
            border-radius: 15px;
            padding: 15px 20px;
            border: 1px solid var(--border-color);
        }

        .motion-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .motion-label {
            color: var(--text-secondary);
        }

        .motion-value {
            color: var(--accent-color);
            font-weight: 600;
        }

        .motion-valid {
            margin-top: 10px;
            font-size: 13px;
        }

        .motion-valid.ok {
            color: var(--success-color);
        }

        .motion-valid.offline {
            color: var(--danger-color);
        }

        .motion-3d-container {
            background: radial-gradient(circle at top, #1f2937, #020617);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            position: relative;
            height: 250px;
            overflow: hidden;
        }

        .motion-3d-overlay {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(15,23,42,0.7);
            padding: 6px 10px;
            border-radius: 999px;
        }

        .alert-list-card {
            margin-top: 20px;
            background: rgba(248, 250, 252, 0.02);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            padding: 16px 20px;
        }

        .alert-list-card h4 {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: var(--warning-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-list {
            list-style: none;
            max-height: 140px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .alert-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px dashed rgba(148, 163, 184, 0.4);
            font-size: 13px;
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .alert-msg {
            color: var(--text-secondary);
        }

        .alert-time {
            color: var(--accent-color);
            margin-left: 8px;
            white-space: nowrap;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-color);
        }

        .chart-performance {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid var(--accent-color);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .performance-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .control-group input[type="range"] {
            width: 100px;
        }

        .control-group input[type="number"] {
            width: 60px;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 5px;
            border-radius: 5px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .health-display {
                grid-template-columns: 1fr;
            }
            
            .health-value {
                font-size: 2.5em;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .device-info {
                flex-direction: column;
                gap: 15px;
            }

            .motion-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <i class="fas fa-wifi"></i>
        <span id="statusText">Đang kết nối...</span>
    </div>

    <header class="header">
        <div class="header-content">
            <h1><i class="fas fa-heartbeat"></i> ESP32-C3 Health Monitor</h1>
            <p>Real-time Heart Rate & SpO2 Monitoring System</p>
        </div>
    </header>

    <div class="main-container">
        <div class="card">
            <h3><i class="fas fa-heartbeat"></i> Health Monitor (MAX30100)</h3>
            
            <div class="health-display">
                <div class="health-value-box heart-rate-box">
                    <div class="health-value" id="heartRate">--</div>
                    <div class="health-unit">BPM</div>
                </div>
                <div class="health-value-box spo2-box">
                    <div class="health-value" id="spo2Value">--</div>
                    <div class="health-unit">SpO2 %</div>
                </div>
            </div>
            
            <div class="status-text" id="sensorStatus">Đang chờ dữ liệu...</div>

            <div class="chart-performance">
                <h4><i class="fas fa-chart-line"></i> Performance Controls</h4>
                <div class="performance-controls">
                    <div class="control-group">
                        <label>Update Rate:</label>
                        <input type="range" id="updateRateSlider" min="100" max="2000" value="500" step="100">
                        <input type="number" id="updateRateValue" value="500" min="100" max="2000">
                        <span>ms</span>
                    </div>
                    <div class="control-group">
                        <label>Data Points:</label>
                        <input type="range" id="dataPointsSlider" min="10" max="100" value="50" step="5">
                        <input type="number" id="dataPointsValue" value="50" min="10" max="100">
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h4><i class="fas fa-chart-line"></i> Heart Rate Trend</h4>
                    <canvas id="heartChart"></canvas>
                </div>
                <div class="chart-card">
                    <h4><i class="fas fa-wave-square"></i> SpO2 Trend</h4>
                    <canvas id="spo2Chart"></canvas>
                </div>
            </div>

            <div class="device-info">
                <div class="info-item">
                    <div class="info-label">IP Address</div>
                    <div class="info-value" id="deviceIP">Đang lấy...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Cập nhật cuối</div>
                    <div class="info-value" id="lastUpdate">--:--:--</div>
                </div>
            </div>

            <div class="card motion-card">
                <h3><i class="fas fa-running"></i> Motion Monitor (MPU6050)</h3>
                <div class="motion-grid">
                    <div class="motion-values">
                        <div class="motion-row">
                            <span class="motion-label">Accel X (g)</span>
                            <span class="motion-value" id="accelX">--</span>
                        </div>
                        <div class="motion-row">
                            <span class="motion-label">Accel Y (g)</span>
                            <span class="motion-value" id="accelY">--</span>
                        </div>
                        <div class="motion-row">
                            <span class="motion-label">Accel Z (g)</span>
                            <span class="motion-value" id="accelZ">--</span>
                        </div>
                        <div class="motion-row">
                            <span class="motion-label">Gyro X (°/s)</span>
                            <span class="motion-value" id="gyroX">--</span>
                        </div>
                        <div class="motion-row">
                            <span class="motion-label">Gyro Y (°/s)</span>
                            <span class="motion-value" id="gyroY">--</span>
                        </div>
                        <div class="motion-row">
                            <span class="motion-label">Gyro Z (°/s)</span>
                            <span class="motion-value" id="gyroZ">--</span>
                        </div>
                        <div class="motion-row">
                            <span class="motion-label">Temp (°C)</span>
                            <span class="motion-value" id="mpuTemp">--</span>
                        </div>
                        <div class="motion-valid offline" id="mpuStatus">
                            Motion sensor offline
                        </div>
                    </div>
                    <div class="motion-3d-container">
                        <div id="motion3d"></div>
                        <div class="motion-3d-overlay">
                            Mô phỏng 3D hướng cổ tay từ gia tốc kế
                        </div>
                    </div>
                </div>
                <div class="alert-list-card">
                    <h4><i class="fas fa-bell"></i> Lịch sử cảnh báo</h4>
                    <ul id="alertList" class="alert-list">
                        <li class="alert-item">
                            <span class="alert-msg">Chưa có cảnh báo nào</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p><i class="fas fa-code"></i> ESP32-C3 Health Monitor</p>
        <p><i class="fas fa-heartbeat"></i> Real-time Heart Rate & SpO2 Monitoring</p>
    </footer>

    <script>
        let deviceIP = '';
        let heartRateChart;
        let spo2Chart;
        let heartRateData = [];
        let spo2Data = [];
        let timeLabels = [];
        let updateInterval;
        let updateRate = 500;
        let maxDataPoints = 50;

        // 3D motion visualization (Three.js)
        let motionScene, motionCamera, motionRenderer, motionCube;
        let targetRotation = { x: 0, z: 0 };
        let currentRotation = { x: 0, z: 0 };
        let motionCalibration = null;
        const rotationSmoothing = 0.15;
        let alertPollInterval = null;

        // Khởi tạo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            updateConnectionStatus('connected', 'Đã kết nối');
            getDeviceIP();
            initCharts();
            initPerformanceControls();
            initMotion3D();
            startHealthUpdates();
            startAlertPolling();
            console.log('Initialization complete');
        });

        // Khởi tạo điều khiển hiệu suất
        function initPerformanceControls() {
            const updateRateSlider = document.getElementById('updateRateSlider');
            const updateRateValue = document.getElementById('updateRateValue');
            const dataPointsSlider = document.getElementById('dataPointsSlider');
            const dataPointsValue = document.getElementById('dataPointsValue');

            updateRateSlider.addEventListener('input', function() {
                updateRate = parseInt(this.value);
                updateRateValue.value = updateRate;
                restartHealthUpdates();
            });

            updateRateValue.addEventListener('change', function() {
                updateRate = parseInt(this.value);
                updateRateSlider.value = updateRate;
                restartHealthUpdates();
            });

            dataPointsSlider.addEventListener('input', function() {
                maxDataPoints = parseInt(this.value);
                dataPointsValue.value = maxDataPoints;
                trimDataPoints();
            });

            dataPointsValue.addEventListener('change', function() {
                maxDataPoints = parseInt(this.value);
                dataPointsSlider.value = maxDataPoints;
                trimDataPoints();
            });
        }

        // Khởi tạo đồ thị
        function initCharts() {
            Chart.defaults.font.family = 'Segoe UI';
            Chart.defaults.font.size = 12;
            Chart.defaults.color = '#cbd5e1';
            Chart.defaults.plugins.legend.display = false;

            const hrCtx = document.getElementById('heartChart').getContext('2d');
            heartRateChart = new Chart(hrCtx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Heart Rate (BPM)',
                        data: heartRateData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.25,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 40,
                            max: 130,
                            title: {
                                display: true,
                                text: 'BPM',
                                color: '#ef4444'
                            },
                            grid: {
                                color: 'rgba(239,68,68,0.15)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#ef4444',
                                font: { size: 12 }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(203,213,225,0.08)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#cbd5e1',
                                font: { size: 11 },
                                maxTicksLimit: 6
                            }
                        }
                    }
                }
            });

            const spoCtx = document.getElementById('spo2Chart').getContext('2d');
            spo2Chart = new Chart(spoCtx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'SpO2 (%)',
                        data: spo2Data,
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.15)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.25,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    interaction: { intersect: false, mode: 'index' },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 70,
                            max: 100,
                            title: {
                                display: true,
                                text: '% SpO2',
                                color: '#06b6d4'
                            },
                            grid: {
                                color: 'rgba(6,182,212,0.15)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#06b6d4',
                                font: { size: 12 }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(203,213,225,0.08)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#cbd5e1',
                                font: { size: 11 },
                                maxTicksLimit: 6
                            }
                        }
                    }
                }
            });
        }

        // Cập nhật trạng thái kết nối
        function updateConnectionStatus(status, text) {
            const statusElement = document.getElementById('connectionStatus');
            const statusTextElement = document.getElementById('statusText');
            statusElement.className = `connection-status ${status}`;
            statusTextElement.textContent = text;
        }

        // Lấy IP của thiết bị
        function getDeviceIP() {
            deviceIP = window.location.hostname || window.location.host;
            document.getElementById('deviceIP').textContent = deviceIP;
            console.log('Device IP:', deviceIP);
        }

        // Bắt đầu cập nhật dữ liệu health
        function startHealthUpdates() {
            updateHealth();
            updateInterval = setInterval(updateHealth, updateRate);
        }

        function startAlertPolling() {
            // Poll alerts riêng, tần số thấp hơn để đỡ tải
            fetchAlerts();
            if (alertPollInterval) {
                clearInterval(alertPollInterval);
            }
            alertPollInterval = setInterval(fetchAlerts, 3000);
        }

        // Khởi động lại cập nhật health
        function restartHealthUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            startHealthUpdates();
        }

        // Cập nhật dữ liệu health
        function updateHealth() {
            if (!deviceIP) {
                console.warn('Device IP not set, retrying...');
                getDeviceIP();
                if (!deviceIP) return;
            }
            
            console.log('Fetching data from /sensor...');
            fetch('/sensor')
                .then(response => {
                    console.log('Response status:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    const timestamp = new Date().toLocaleTimeString();
                    
                    if (data && typeof data.heart_rate !== 'undefined' && typeof data.spo2 !== 'undefined') {
                        // Hiển thị Heart Rate
                        if (data.heart_rate > 0 && data.valid) {
                            document.getElementById('heartRate').textContent = data.heart_rate.toFixed(0);
                        } else {
                            document.getElementById('heartRate').textContent = '--';
                        }
                        
                        // Hiển thị SpO2 nếu có giá trị hợp lệ (70-100)
                        if (data.spo2 >= 70 && data.spo2 <= 100) {
                            document.getElementById('spo2Value').textContent = data.spo2.toFixed(1);
                        } else {
                            document.getElementById('spo2Value').textContent = '--';
                        }
                        
                        // Cập nhật status
                        if (data.valid) {
                            document.getElementById('sensorStatus').textContent = 'Dữ liệu hợp lệ';
                            document.getElementById('sensorStatus').style.color = '#10b981';
                        } else if (data.spo2 >= 70 && data.spo2 <= 100) {
                            document.getElementById('sensorStatus').textContent = 'Đang đo SpO2... (chờ Heart Rate)';
                            document.getElementById('sensorStatus').style.color = '#f59e0b';
                        } else {
                            document.getElementById('sensorStatus').textContent = 'Đang chờ ngón tay...';
                            document.getElementById('sensorStatus').style.color = '#f59e0b';
                        }
                        
                        document.getElementById('lastUpdate').textContent = timestamp;
                        
                        // Cập nhật chart nếu có dữ liệu hợp lệ
                        if (data.spo2 >= 70 && data.spo2 <= 100) {
                            updateChartData(data.heart_rate || 0, data.spo2, timestamp);
                        }

                        // Cập nhật thông tin motion (MPU6050)
                        updateMotionData(data);
                        
                        updateConnectionStatus('connected', 'Đã kết nối');
                    } else {
                        console.warn('Invalid data format:', data);
                        document.getElementById('heartRate').textContent = '--';
                        document.getElementById('spo2Value').textContent = '--';
                        document.getElementById('sensorStatus').textContent = 'Dữ liệu không hợp lệ';
                        document.getElementById('sensorStatus').style.color = '#ef4444';
                    }
                })
                .catch(error => {
                    console.error('Error reading sensor data:', error);
                    document.getElementById('sensorStatus').textContent = 'Lỗi kết nối: ' + error.message;
                    document.getElementById('sensorStatus').style.color = '#ef4444';
                    updateConnectionStatus('disconnected', 'Mất kết nối');
                });
        }

        // Khởi tạo 3D scene cho motion
        function initMotion3D() {
            const container = document.getElementById('motion3d');
            if (!container || typeof THREE === 'undefined') {
                console.warn('Three.js or container not available, skipping 3D motion');
                return;
            }

            const width = container.clientWidth || container.offsetWidth || 300;
            const height = container.clientHeight || container.offsetHeight || 250;

            motionScene = new THREE.Scene();
            motionCamera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            motionCamera.position.set(0, 0, 5);

            motionRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            motionRenderer.setSize(width, height);
            container.appendChild(motionRenderer.domElement);

            const geometry = new THREE.BoxGeometry(1.5, 0.5, 2.5);
            const material = new THREE.MeshStandardMaterial({
                color: 0x3b82f6,
                metalness: 0.3,
                roughness: 0.5
            });
            motionCube = new THREE.Mesh(geometry, material);
            motionScene.add(motionCube);

            // Light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(3, 4, 5);
            motionScene.add(ambientLight);
            motionScene.add(dirLight);

            // Simple animation loop
            function animate() {
                requestAnimationFrame(animate);

                // Easing để chuyển động mượt hơn, giảm giật
                currentRotation.x += (targetRotation.x - currentRotation.x) * rotationSmoothing;
                currentRotation.z += (targetRotation.z - currentRotation.z) * rotationSmoothing;

                if (motionCube) {
                    motionCube.rotation.x = currentRotation.x;
                    motionCube.rotation.z = currentRotation.z;
                }

                motionRenderer.render(motionScene, motionCamera);
            }
            animate();
        }

        // Cập nhật dữ liệu motion & mô phỏng 3D
        function updateMotionData(data) {
            const hasMPU =
                data &&
                typeof data.accel === 'object' &&
                typeof data.accel.x === 'number' &&
                typeof data.accel.y === 'number' &&
                typeof data.accel.z === 'number';

            const accelXEl = document.getElementById('accelX');
            const accelYEl = document.getElementById('accelY');
            const accelZEl = document.getElementById('accelZ');
            const gyroXEl = document.getElementById('gyroX');
            const gyroYEl = document.getElementById('gyroY');
            const gyroZEl = document.getElementById('gyroZ');
            const tempEl = document.getElementById('mpuTemp');
            const statusEl = document.getElementById('mpuStatus');

            if (!hasMPU || !data.mpu_valid) {
                if (statusEl) {
                    statusEl.textContent = 'Motion sensor offline hoặc không có dữ liệu';
                    statusEl.classList.remove('ok');
                    statusEl.classList.add('offline');
                }
                if (accelXEl) accelXEl.textContent = '--';
                if (accelYEl) accelYEl.textContent = '--';
                if (accelZEl) accelZEl.textContent = '--';
                if (gyroXEl) gyroXEl.textContent = '--';
                if (gyroYEl) gyroYEl.textContent = '--';
                if (gyroZEl) gyroZEl.textContent = '--';
                if (tempEl) tempEl.textContent = '--';
                return;
            }

            const ax = data.accel.x;
            const ay = data.accel.y;
            const az = data.accel.z;
            const gx = (data.gyro && typeof data.gyro.x === 'number') ? data.gyro.x : 0;
            const gy = (data.gyro && typeof data.gyro.y === 'number') ? data.gyro.y : 0;
            const gz = (data.gyro && typeof data.gyro.z === 'number') ? data.gyro.z : 0;

            if (accelXEl) accelXEl.textContent = ax.toFixed(2);
            if (accelYEl) accelYEl.textContent = ay.toFixed(2);
            if (accelZEl) accelZEl.textContent = az.toFixed(2);
            if (gyroXEl) gyroXEl.textContent = gx.toFixed(1);
            if (gyroYEl) gyroYEl.textContent = gy.toFixed(1);
            if (gyroZEl) gyroZEl.textContent = gz.toFixed(1);
            if (tempEl && typeof data.mpu_temp === 'number') {
                tempEl.textContent = data.mpu_temp.toFixed(1);
            }

            if (statusEl) {
                statusEl.textContent = 'Motion sensor online';
                statusEl.classList.remove('offline');
                statusEl.classList.add('ok');
            }

            // Cập nhật hướng cube 3D dựa trên vector trọng lực từ accel
            if (motionCube) {

                // Chuẩn hóa vector accel
                const len = Math.max(Math.sqrt(ax * ax + ay * ay + az * az), 0.0001);
                const nx = ax / len;
                const ny = ay / len;
                const nz = az / len;

                // Công thức chuẩn MPU6050
                const roll  = Math.atan2(ny, nz);  // xoay theo trục Z trong Three.js (roll)
                const pitch = Math.atan2(-nx, Math.sqrt(ny * ny + nz * nz)); // xoay theo trục X (pitch)

                // Lấy mốc đứng yên
                if (!motionCalibration) {
                    motionCalibration = { roll, pitch };
                }

                const relativeRoll  = roll  - motionCalibration.roll;
                const relativePitch = pitch - motionCalibration.pitch;

                // Mapping chuẩn sang Three.js
                targetRotation.x = relativePitch;     // pitch → xoay X
                targetRotation.z = relativeRoll;     // roll  → xoay Z (ĐẢO dấu để đúng hướng)
                
            } else {
                motionCalibration = null;
            }

        }

        // Lấy danh sách cảnh báo từ ESP32
        function fetchAlerts() {
            fetch('/alerts')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && Array.isArray(data.alerts)) {
                        renderAlertList(data.alerts);
                    }
                })
                .catch(err => {
                    console.warn('Failed to fetch alerts:', err);
                });
        }

        // Hiển thị danh sách cảnh báo
        function renderAlertList(alerts) {
            const listEl = document.getElementById('alertList');
            if (!listEl) return;

            listEl.innerHTML = '';

            if (!alerts.length) {
                const li = document.createElement('li');
                li.className = 'alert-item';
                li.innerHTML = '<span class="alert-msg">Chưa có cảnh báo nào</span>';
                listEl.appendChild(li);
                return;
            }

            alerts.forEach(alert => {
                const li = document.createElement('li');
                li.className = 'alert-item';

                const msgSpan = document.createElement('span');
                msgSpan.className = 'alert-msg';
                msgSpan.textContent = alert.msg || '';

                const timeSpan = document.createElement('span');
                timeSpan.className = 'alert-time';
                // t là ms từ khi boot; hiển thị giây tương đối
                if (typeof alert.t === 'number') {
                    const seconds = (alert.t / 1000).toFixed(1);
                    timeSpan.textContent = `${seconds}s`;
                }

                li.appendChild(msgSpan);
                li.appendChild(timeSpan);
                listEl.appendChild(li);
            });
        }

        // Cập nhật dữ liệu đồ thị
        function updateChartData(heartRate, spo2, timestamp) {
            heartRateData.push(heartRate);
            spo2Data.push(spo2);
            timeLabels.push(timestamp);
            
            if (heartRateData.length > maxDataPoints) {
                heartRateData.shift();
                spo2Data.shift();
                timeLabels.shift();
            }
            
            if (heartRateChart && heartRateData.length > 1) {
                heartRateChart.data.labels = timeLabels;
                heartRateChart.data.datasets[0].data = heartRateData;
                heartRateChart.update('none');
            }
            if (spo2Chart && spo2Data.length > 1) {
                spo2Chart.data.labels = timeLabels;
                spo2Chart.data.datasets[0].data = spo2Data;
                spo2Chart.update('none');
            }
        }

        // Cắt dữ liệu theo số điểm tối đa
        function trimDataPoints() {
            if (heartRateData.length > maxDataPoints) {
                const excess = heartRateData.length - maxDataPoints;
                heartRateData.splice(0, excess);
                spo2Data.splice(0, excess);
                timeLabels.splice(0, excess);
                
                if (heartRateChart) {
                    heartRateChart.data.labels = timeLabels;
                    heartRateChart.data.datasets[0].data = heartRateData;
                    heartRateChart.update('none');
                }
                if (spo2Chart) {
                    spo2Chart.data.labels = timeLabels;
                    spo2Chart.data.datasets[0].data = spo2Data;
                    spo2Chart.update('none');
                }
            }
        }

        // Kiểm tra kết nối định kỳ
        setInterval(() => {
            if (deviceIP) {
                fetch('/sensor')
                    .then(response => {
                        if (response.ok) {
                            updateConnectionStatus('connected', 'Đã kết nối');
                        } else {
                            updateConnectionStatus('disconnected', 'Lỗi kết nối');
                        }
                    })
                    .catch(() => {
                        updateConnectionStatus('disconnected', 'Mất kết nối');
                    });
            }
        }, 10000);
    </script>
</body>
</html>
